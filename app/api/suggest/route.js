import fetch from 'node-fetch'
async function fetchQuote(symbol){ const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbol)}`; const r = await fetch(url); return r.json() }
function analyze({pe, changePercent, vix}){ const fundOK = (pe !== undefined && pe !== null && pe < 20); const volatile = (vix !== undefined && vix > 20); let techStrong = (Math.abs(changePercent || 0) > 1 && !volatile); if(fundOK && techStrong) return 'Fundamentally & technically strong — Consider BUY for swing.'; if(fundOK && !techStrong) return 'Fundamentally strong but technically weak — Consider HOLD.'; if(!fundOK && techStrong) return 'Technically strong but fundamentals weak — Trade with caution.'; return 'Weak fundamentally and technically — Avoid / Research more.' }
export async function POST(req){ try{ const { query } = await req.json(); const symbol = (query || 'TCS.NS').trim(); const quoteData = await fetchQuote(symbol); const quote = quoteData?.quoteResponse?.result?.[0] || {}; const pe = quote.forwardPE || quote.trailingPE || null; const vixResp = await fetch('https://query1.finance.yahoo.com/v7/finance/quote?symbols=%5EINDIAVIX'); const vixJson = await vixResp.json(); const vixVal = vixJson?.quoteResponse?.result?.[0]?.regularMarketPrice || null; const suggestion = analyze({ pe, changePercent: quote.regularMarketChangePercent, vix: vixVal }); return new Response(JSON.stringify({ suggestion, symbol, price: quote.regularMarketPrice || null, pe, vix: vixVal }), { status: 200, headers: { 'content-type': 'application/json' } }) }catch(e){ return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: { 'content-type': 'application/json' } }) } }
